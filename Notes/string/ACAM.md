# AC自动机

[[HNCPC2021]String Set](https://vjudge.net/problem/CSG-1166)

考虑没有删除操作时如何做。对插入串建自动机并不好做，所以我们对所有查询串建立AC自动机，然后计算每个插入串对每个询问的贡献。

和一个经典问题非常相似：[[COCI2015]Divljak](https://www.luogu.com.cn/problem/P5840)

对于一个插入串，暴力在AC自动机上匹配，设经过的点为 $u_1,u_2,...,u_k$，这些点在 $\text{fail}$ 树上到根节点的路径上的点集贡献加+1。利用树上差分解决这个问题，首先将 $u_1,u_2,...,u_k +1$，然后将这些点按照 $dfn$ 序排序后将 $lca(u_1,u_2),lca(u_2,u_3)...-1$，就可以将路径修改+单点查询变成单点修改+子树查询。

使用树状数组或线段树维护贡献，从左往右遍历操作，按照顺序执行插入的贡献计算和查询，以确保每次查询的结果都不包含时间线之后的贡献。

现在考虑如何处理删除。每个插入串都只会作用一段时间区间，这个串被删除之后，它造成的贡献也要一并删除。我们将所有的删除串也建立AC自动机，每个节点存储一个时间值，初始为正无穷。按照时间倒着从右往左的顺序处理删除串和插入串：

- 对于删除串，找到其在 $\text{fail}$ 树的位置，更新整棵子树的时间。
- 对于插入串，暴力在AC自动机上匹配，将经过点的时间取 $\min$。之后在操作序列的对应时间插入一个新操作 $R$，表示插入的逆操作，执行和插入同样的步骤但是计-1的贡献，用来抵消之前的插入贡献。

时间复杂度 $\mathcal{O} (|S| \log |S|)$,$|S|$ 为总串长。

